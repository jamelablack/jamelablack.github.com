<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      grit| commit &middot; A coding blog by Jam
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0c">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          <span style="color: #FF6347; font: Verdana">grit| commit</span>
        </a>
      </h1>
      <p class="lead">daily learnings as a ruby dev</p>
    </div>



    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href=""></a>

            <a class="sidebar-nav-item" href="/about/">About</a>

          
        
      
        
          
            <a class="sidebar-nav-item" href=""></a>

            <a class="sidebar-nav-item" href="/archive/">Archive</a>

          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/24/course3-staging-prod-server/">
        Build Robust & Production Quality Applications - Lesson 6: Staging Server & Production Servers
      </a>
    </h1>

    <span class="post-date">24 May 2015</span>

    <p>Follow this tutorial on <a href="https://devcenter.heroku.com/articles/multiple-environments">Heroku</a> to understand the difference between staging and prodcution</p>

<p>A few things I&#39;d like to add:</p>

<p>1) Make staging server&#39;s configuration and data as close to the production server as possible - after all, the purpose of having the staging server is to be able to test out new features in a &quot;production like&quot; environment.</p>

<p>If you production app is already launched, you can periodically take database dumps from the production server to populate the staging server. You could automate this as well with either a replication service, or if you are on Heroku, use Heroku&#39;s follower DB (comes with a cost) https://devcenter.heroku.com/articles/heroku-postgres-follower-databases</p>

<p>2) You want to be mindful on email sending on staging - staging server will actually send out emails. You want to make sure that you do not spam your users while testing out features on the staging server. This can be achieved by adding a conditional in your mailer to see if the environment is staging, and if it is, set email recipients to administrators (such as yourself). This way, you can still test and verify that emails are sent out, but you don&#39;t spam users.</p>

<p>3) Your staging server can (and typically should) have a different config itself - you just need to create a staging.rb file in config/environments directory, and with it you can specify the exact settings you want on there (for example, turning on asset pipeline or not, sending out email or not, charging credit card for real or not, etc). On your Heroku staging server, make sure to set RACK<em>ENV and RAILS</em>ENV to staging, then it&#39;ll use that config instead.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/22/course3-staging-vs-production/">
        Course3 Staging Vs Production
      </a>
    </h1>

    <span class="post-date">22 May 2015</span>

    
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/20/course3-riding_unicorns/">
        Build Robust & Production Quality Applications - Lesson 6: Riding Unicorns
      </a>
    </h1>

    <span class="post-date">20 May 2015</span>

    <h2>Using Unicorn as a Production Server</h2>

<p>Visit http://devcenter.heroku.com/articles/rails-unicorn</p>

<p>The issue with the rails server, is that it only allows for one web process at a time. Unicorn allows you to add additional servers, which can be specified in your config/unicorn.rb file</p>

<h3>1. Add the Unicorn gem to your gemfile</h3>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;unicorn&#39;</span></code></pre></div>

<p>then, run bundle install</p>

<h3>2. Config</h3>

<p>This is where you define the number worker processes. Worker processes in this context is all processes not just background processes. Below indicates that we want three worker processes running at once.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#config/unicorn.rb</span>
<span class="n">worker_processes</span> <span class="nb">Integer</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;WEB_CONCURRENCY&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">timeout</span> <span class="mi">15</span>
<span class="n">preload_app</span> <span class="kp">true</span></code></pre></div>

<h3>Update your Procfile</h3>

<p>Set Unicorn as the server for the web process in your Procfile:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">web</span><span class="p">:</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">unicorn</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="o">-</span><span class="n">c</span> <span class="o">.</span><span class="n">/config</span><span class="o">/</span><span class="n">unicorn</span><span class="o">.</span><span class="n">rb</span></code></pre></div>

<h2>Adding Unicorn to your Heroku App</h2>

<h3>1. Add Redis to go</h3>

<p>heroku addons:create redistogo</p>

<h3>2. Run the following for Sidekiq version 3.0 or later:</h3>

<p>heroku config:set REDIS<em>PROVIDER=REDISTOGO</em>URL</p>

<h3>3 <a href="https://coderwall.com/p/fprnhg/free-background-jobs-on-heroku">Free background job on Heroku</a></h3>

<p>Running more than 1 dyno (server) on Heroku costs, and ain&#39;t nobody got time for that. Coderwall has created a hack:</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/10/course3-procfile-foreman/">
        Course3 Procfile Foreman
      </a>
    </h1>

    <span class="post-date">10 May 2015</span>

    <hr>

<p>layout: post
  title: &quot;Build Robust &amp; Production Quality Applications - Lesson 6: Procfile &amp; Foreman&quot;
  tags: tealeaf</p>

<hr>

<p>On your server, you can run both web and worker processes locally - you can also do the same on Heroku, identifiying the processes you would like to run in your Procfile. A procfile is placed in the root of your diretory and declare what types of processes you want run in your app.</p>

<p>In your procfile, you will define:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="n">process</span> <span class="n">type</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;</span>
<span class="ss">web</span><span class="p">:</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rails</span> <span class="n">server</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span>
<span class="ss">worker</span><span class="p">:</span> <span class="n">bundle</span> <span class="nb">exec</span> <span class="n">rake</span> <span class="ss">jobs</span><span class="p">:</span><span class="n">work</span> <span class="p">(</span><span class="n">example</span> <span class="n">from</span> <span class="n">delayed</span> <span class="n">jobs</span><span class="p">)</span>
<span class="ss">worker</span><span class="p">:</span> <span class="n">sidekiq</span></code></pre></div>

<h2>Develop locally with Foreman</h2>

<p>Instead of having to start both Sidekiq and our Rails server locally, we can use format to initiate both processes by runniong &quot;foreman start&quot; in your app directory.</p>

<h2>Heroku</h2>

<p>will parse out the web processes from your Procfile.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">heroku</span> <span class="n">ps</span></code></pre></div>

<p>will list the processes running</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">heroku</span> <span class="n">logs</span></code></pre></div>

<p>will list all process types</p>

<p>Heroku will allow you to run one web &amp; worker processes but if you&#39;d like to run more, it may costs.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/05/05/course3-background-jobs/">
        Build Robust & Production Quality Applications - Lesson 6: Background Jobs
      </a>
    </h1>

    <span class="post-date">05 May 2015</span>

    <h2>Background Jobs</h2>

<p>Email sending typically is not very fast since we have to rely on some third party application. Waiting can slow up your app and potentially frustrate users so it&#39;s best to put non-essential and non-time-sensitive tasks in background jobs.</p>

<p>Since you can web processes and background job processes running locally, you need tp run both the rails server and sidekiq servers to process jobs respectively.</p>

<h3>Resque</h3>

<p>came out of Github - Resque is our Redis-backed library for creating background jobs, placing those jobs on multiple queues, and processing them later.</p>

<p>Benefits: has admin interface, is powered by Github
Delayed Job does not require Redis, both uses a pulling queue
Beanstalk and Stalker may be better if you care about speed, as they have a pulling mechanism</p>

<p>Sidekiq is a higher performance background solution than Resque and can even be ported, added on top of resque solution.</p>

<p>Check out the Railscast on Resque for intro.</p>

<h3>Sidekiq</h3>

<p>In order to use Sidekiq, you must install and run <a href="http://redis.io">Redis</a>. Once downloaded, run the &quot;$ src/redis-server&quot; in the redis-3.0.2 folder.</p>

<p>You must also gem install sidekiq, and run &quot;bundle exec sidekiq&quot;</p>

<p>When watching the Railscast on Sidekiq, it talks about the creation of workers:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#app/controllers/invitations_controller.rb</span>
<span class="k">class</span> <span class="nc">InvitationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:require_user</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@invitation</span> <span class="o">=</span> <span class="no">Invitation</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@invitation</span> <span class="o">=</span> <span class="no">Invitation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">invitation_params</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="ss">inviter_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="k">if</span> <span class="vi">@invitation</span><span class="o">.</span><span class="n">save</span>
      <span class="no">InivtationWorker</span><span class="o">.</span><span class="n">perform_async</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve successfully invited </span><span class="si">#{</span><span class="vi">@invitation</span><span class="o">.</span><span class="n">recipient_name</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="n">redirect_to</span> <span class="n">new_invitation_path</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please fill in all inputs.&quot;</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#app/workers</span>
<span class="k">class</span> <span class="nc">InvitationWorker</span>
  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="n">invitation</span> <span class="o">=</span> <span class="no">Invitation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="no">AppMailer</span><span class="o">.</span><span class="n">send_invitation_email</span><span class="p">(</span><span class="n">invitation</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>But instead of creating workers, we can just use <a href="https://github.com/mperham/sidekiq/wiki/Delayed-extensions#actionmailer">delayed extentions</a></p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#app/controlers/invitations_controller.rb</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@invitation</span> <span class="o">=</span> <span class="no">Invitation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">invitation_params</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="ss">inviter_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="k">if</span> <span class="vi">@invitation</span><span class="o">.</span><span class="n">save</span>
      <span class="no">AppMailer</span><span class="o">.</span><span class="n">delay</span><span class="o">.</span><span class="n">send_invitation_email</span><span class="p">(</span><span class="vi">@invitation</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve successfully invited </span><span class="si">#{</span><span class="vi">@invitation</span><span class="o">.</span><span class="n">recipient_name</span><span class="si">}</span><span class="s2">.&quot;</span>
      <span class="n">redirect_to</span> <span class="n">new_invitation_path</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please fill in all inputs.&quot;</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></div>

<p>Since we aren&#39;t running .perform_async on a worker, we need to pass @invitiation.id to the AppMailer:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#app/app_mailer.rb</span>
<span class="k">def</span> <span class="nf">send_invitation_email</span><span class="p">(</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="vi">@invitation</span> <span class="o">=</span> <span class="no">Invitation</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">invitation_id</span><span class="p">)</span>
    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="vi">@invitation</span><span class="o">.</span><span class="n">recipient_email</span><span class="p">,</span> <span class="ss">from</span><span class="p">:</span> <span class="s2">&quot;info@myflix.com&quot;</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">&quot;Invitation to join Myflix&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>To run tests, you have to add the following to run them <a href="https://github.com/mperham/sidekiq/wiki/Testing">inline</a>:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#spec/spec_helper.rb</span>

<span class="nb">require</span> <span class="s1">&#39;sidekiq/testing&#39;</span>
<span class="no">Sidekiq</span><span class="o">::</span><span class="no">Testing</span><span class="o">.</span><span class="n">inline!</span></code></pre></div>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page6">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page4">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
